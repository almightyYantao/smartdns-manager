name: Build and Release Agent
on:
  push:
    tags:
      - 'agent-patch'  # è¡¥ä¸ç‰ˆæœ¬
      - 'agent-minor'  # å°ç‰ˆæœ¬
      - 'agent-major'  # å¤§ç‰ˆæœ¬

env:
  BINARY_NAME: smartdns-log-agent
  AGENT_DIR: agent

jobs:
  generate-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      version_number: ${{ steps.version.outputs.version_number }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate version tag
        id: version
        run: |
          # è·å–è§¦å‘çš„æ ‡ç­¾ç±»å‹
          TRIGGER_TAG="${{ github.ref_name }}"

          # è·å–æœ€æ–°ç‰ˆæœ¬
          LATEST_TAG=$(git tag -l "agent-v*" | sort -V | tail -n1)

          if [ -z "$LATEST_TAG" ]; then
            NEW_VERSION="agent-v0.0.1"
            VERSION_NUMBER="0.0.1"
          else
            VERSION_NUMBER=$(echo $LATEST_TAG | sed 's/agent-v//')
            IFS='.' read -r major minor patch <<< "$VERSION_NUMBER"

            case $TRIGGER_TAG in
              agent-major)
                NEW_MAJOR=$((major + 1))
                VERSION_NUMBER="${NEW_MAJOR}.0.0"
                ;;
              agent-minor)  
                NEW_MINOR=$((minor + 1))
                VERSION_NUMBER="${major}.${NEW_MINOR}.0"
                ;;
              *)  # agent, agent-patch, or default
                NEW_PATCH=$((patch + 1))
                VERSION_NUMBER="${major}.${minor}.${NEW_PATCH}"
                ;;
            esac

            NEW_VERSION="agent-v${VERSION_NUMBER}"
          fi

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
          echo "Generated new version: $NEW_VERSION (triggered by: $TRIGGER_TAG)"
          
          # åˆ›å»ºæ–°çš„ç‰ˆæœ¬æ ‡ç­¾
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag $NEW_VERSION
          git push origin $NEW_VERSION
          
          # åˆ é™¤è§¦å‘æ ‡ç­¾
          git push origin :refs/tags/agent

  build-and-package:
    needs: generate-version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: arm
            goarm: 7
            suffix: linux-armv7
          - goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - goos: windows
            goarch: amd64
            suffix: windows-amd64.exe
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('agent/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build binary
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          cd ${{ env.AGENT_DIR }}
          
          go build -ldflags "-s -w -X main.Version=${{ needs.generate-version.outputs.new_version }}" \
            -o ../${{ env.BINARY_NAME }}-${{ matrix.suffix }} main.go
          
          cd ..
          
          if [ "${{ matrix.goos }}" != "windows" ]; then
            file ${{ env.BINARY_NAME }}-${{ matrix.suffix }}
          fi
          
          echo "âœ… Binary built: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}"
          ls -la ${{ env.BINARY_NAME }}-${{ matrix.suffix }}

      - name: Create release package
        run: |
          mkdir -p release-${{ matrix.suffix }}
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp ${{ env.BINARY_NAME }}-${{ matrix.suffix }} release-${{ matrix.suffix }}/
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶(ä½¿ç”¨ 2>/dev/null || true é¿å…æ–‡ä»¶ä¸å­˜åœ¨çš„é”™è¯¯)
          cp ${{ env.AGENT_DIR }}/docker-compose.yml release-${{ matrix.suffix }}/ 2>/dev/null || echo "docker-compose.yml not found"
          cp ${{ env.AGENT_DIR }}/config.env release-${{ matrix.suffix }}/ 2>/dev/null || echo "config.env not found"
          cp ${{ env.AGENT_DIR }}/README.md release-${{ matrix.suffix }}/ 2>/dev/null || echo "README.md not found"
          
          # å¤åˆ¶å®‰è£…è„šæœ¬(å¦‚æœå­˜åœ¨)
          if [ -f "${{ env.AGENT_DIR }}/install.sh" ]; then
            cp ${{ env.AGENT_DIR }}/install.sh release-${{ matrix.suffix }}/
          fi
          
          # å¤åˆ¶æœåŠ¡æ–‡ä»¶(å¦‚æœå­˜åœ¨)
          if [ -f "${{ env.AGENT_DIR }}/smartdns-log-agent.service" ]; then
            cp ${{ env.AGENT_DIR }}/smartdns-log-agent.service release-${{ matrix.suffix }}/
          fi
          
          echo "Package contents:"
          ls -la release-${{ matrix.suffix }}/

      - name: Generate management script
        run: |
          cat > release-${{ matrix.suffix }}/manage.sh << 'EOF'
          #!/bin/bash
          
          SERVICE_NAME="smartdns-log-agent"
          BINARY_NAME="smartdns-log-agent"
          
          case "$1" in
              start)
                  echo "Starting $SERVICE_NAME..."
                  sudo systemctl start $SERVICE_NAME
                  ;;
              stop)
                  echo "Stopping $SERVICE_NAME..."
                  sudo systemctl stop $SERVICE_NAME
                  ;;
              restart)
                  echo "Restarting $SERVICE_NAME..."
                  sudo systemctl restart $SERVICE_NAME
                  ;;
              status)
                  sudo systemctl status $SERVICE_NAME
                  ;;
              logs)
                  sudo journalctl -u $SERVICE_NAME -f
                  ;;
              install)
                  echo "Installing $SERVICE_NAME..."
                  # æŸ¥æ‰¾äºŒè¿›åˆ¶æ–‡ä»¶(æ”¯æŒä¸åŒçš„å‘½åæ ¼å¼)
                  for binary in $BINARY_NAME-* $BINARY_NAME; do
                    if [ -f "$binary" ] && [ -x "$binary" ]; then
                      sudo cp "$binary" /usr/local/bin/$BINARY_NAME
                      break
                    fi
                  done
                  sudo chmod +x /usr/local/bin/$BINARY_NAME
          
                  # åˆ›å»ºç”¨æˆ·
                  if ! id "$SERVICE_NAME" &>/dev/null; then
                      sudo useradd -r -s /bin/false $SERVICE_NAME
                  fi
          
                  # åˆ›å»ºé…ç½®ç›®å½•
                  sudo mkdir -p /etc/$SERVICE_NAME
                  if [ -f "config.env" ]; then
                      sudo cp config.env /etc/$SERVICE_NAME/config
                  fi
                  sudo chown -R $SERVICE_NAME:$SERVICE_NAME /etc/$SERVICE_NAME
          
                  # å®‰è£…æœåŠ¡æ–‡ä»¶
                  if [ -f "$SERVICE_NAME.service" ]; then
                      sudo cp $SERVICE_NAME.service /etc/systemd/system/
                      sudo systemctl daemon-reload
                      sudo systemctl enable $SERVICE_NAME
                  fi
          
                  echo "Installation completed. Use 'sudo ./manage.sh start' to start the service."
                  ;;
              uninstall)
                  echo "Uninstalling $SERVICE_NAME..."
                  sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
                  sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
                  sudo rm -f /etc/systemd/system/$SERVICE_NAME.service
                  sudo rm -f /usr/local/bin/$BINARY_NAME
                  sudo rm -rf /etc/$SERVICE_NAME
                  sudo systemctl daemon-reload
                  echo "Uninstallation completed."
                  ;;
              *)
                  echo "Usage: $0 {start|stop|restart|status|logs|install|uninstall}"
                  exit 1
                  ;;
          esac
          EOF
          
          chmod +x release-${{ matrix.suffix }}/manage.sh

      - name: Generate install guide
        run: |
          cat > release-${{ matrix.suffix }}/INSTALL.md << EOF
          # SmartDNS Log Agent å®‰è£…æŒ‡å—
          
          ## ç‰ˆæœ¬ä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ needs.generate-version.outputs.new_version }}
          - **æ„å»ºæ—¶é—´**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **å¹³å°**: ${{ matrix.suffix }}
          
          ## å¿«é€Ÿå®‰è£…
          
          \`\`\`bash
          # ä½¿ç”¨ç®¡ç†è„šæœ¬å®‰è£…
          sudo ./manage.sh install
          
          # å¯åŠ¨æœåŠ¡
          sudo ./manage.sh start
          
          # æŸ¥çœ‹çŠ¶æ€
          sudo ./manage.sh status
          \`\`\`
          
          ## Docker éƒ¨ç½²
          
          \`\`\`bash
          # ç¼–è¾‘ç¯å¢ƒå˜é‡
          cp config.env .env
          nano .env
          
          # å¯åŠ¨æœåŠ¡
          docker-compose up -d
          \`\`\`
          
          ## é…ç½®è¯´æ˜
          
          ç¼–è¾‘ \`/etc/smartdns-log-agent/config\` æ–‡ä»¶æˆ–ç¯å¢ƒå˜é‡:
          
          \`\`\`bash
          NODE_ID=1
          CLICKHOUSE_HOST=localhost
          CLICKHOUSE_PORT=9000
          CLICKHOUSE_DB=smartdns_logs
          CLICKHOUSE_USER=default
          CLICKHOUSE_PASSWORD=your-password
          LOG_FILE=/var/log/smartdns/smartdns.log
          BATCH_SIZE=1000
          FLUSH_INTERVAL_SEC=2
          \`\`\`
          
          ## ç®¡ç†å‘½ä»¤
          
          \`\`\`bash
          sudo ./manage.sh start     # å¯åŠ¨æœåŠ¡
          sudo ./manage.sh stop      # åœæ­¢æœåŠ¡
          sudo ./manage.sh restart   # é‡å¯æœåŠ¡
          sudo ./manage.sh status    # æŸ¥çœ‹çŠ¶æ€
          sudo ./manage.sh logs      # æŸ¥çœ‹æ—¥å¿—
          sudo ./manage.sh install   # å®‰è£…æœåŠ¡
          sudo ./manage.sh uninstall # å¸è½½æœåŠ¡
          \`\`\`
          EOF

      - name: Create package
        run: |
          tar -czf ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz -C release-${{ matrix.suffix }} .
          
          echo "âœ… Package created:"
          ls -la ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.suffix }}
          path: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz
          retention-days: 30

  create-release:
    needs: [generate-version, build-and-package]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          pattern: package-*
          path: releases/
          merge-multiple: true

      - name: Prepare release files
        run: |
          # ç»Ÿè®¡ç»“æœ
          file_count=$(ls releases/*.tar.gz 2>/dev/null | wc -l)
          echo "ğŸ“Š Final release files count: $file_count"
          
          if [ $file_count -gt 0 ]; then
            echo "ğŸ“‹ Release files:"
            ls -la releases/
          else
            echo "âš ï¸  No release files found, adding placeholder"
            mkdir -p releases
            touch releases/README.txt
            echo "Release packages are being built. Please check the Actions tab." > releases/README.txt
          fi

      - name: Generate dynamic release notes
        run: |
          file_count=$(ls releases/*.tar.gz 2>/dev/null | wc -l)
          cat > release-notes.md << EOF
          ## SmartDNS Log Agent ${{ needs.generate-version.outputs.new_version }}
          é«˜æ€§èƒ½çš„ SmartDNS æ—¥å¿—æ”¶é›†å’Œåˆ†æä»£ç†ã€‚
          
          ### ğŸš€ å¿«é€Ÿå®‰è£…
          > **æ³¨æ„**: éœ€è¦ root æƒé™,è¯·æ›¿æ¢å®é™…çš„èŠ‚ç‚¹IDã€ClickHouseåœ°å€å’Œå¯†ç 
          \`\`\`bash
          # ä¸€é”®å®‰è£…(æ¨èæ–¹å¼)
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- -n [èŠ‚ç‚¹ID] -H [ClickHouseåœ°å€] -p "[å¯†ç ]"
          # ç¤ºä¾‹
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- -n 1 -H 192.168.1.100 -p "mypassword"
          \`\`\`
          ### ğŸ³ Docker æ¨¡å¼
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- -n 1 -H 192.168.1.100 -p "password" -m docker
          \`\`\`
          ### ğŸ”§ å®Œæ•´å‚æ•°å®‰è£…
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \\
            -n 1 \\
            -N "my-node" \\
            -H 192.168.1.100 \\
            -P 9000 \\
            -d smartdns_logs \\
            -u default \\
            -p "your_password" \\
            -l /var/log/smartdns/audit.log \\
            -m systemd
          \`\`\`
          ### ğŸ“‹ å‚æ•°è¯´æ˜
          | å‚æ•° | ç®€å†™ | è¯´æ˜ | å¿…éœ€ | é»˜è®¤å€¼ |
          |------|------|------|------|--------|
          | \`--node-id\` | \`-n\` | èŠ‚ç‚¹ID | âœ… | - |
          | \`--clickhouse-host\` |  \`-H\` | ClickHouseä¸»æœºåœ°å€ | âœ… | - |
          | \`--node-name\` | \`-N\` | èŠ‚ç‚¹åç§° | âŒ | node-ID |
          | \`--clickhouse-port\` | \`-P\` | ClickHouseç«¯å£ | âŒ | 9000 |
          | \`--clickhouse-db\` | \`-d\` | æ•°æ®åº“å | âŒ | smartdns_logs |
          | \`--clickhouse-user\` | \`-u\` | ç”¨æˆ·å | âŒ | default |
          | \`--clickhouse-password\` | \`-p\` | å¯†ç  | âŒ | - |
          | \`--log-file\` | \`-l\` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | âŒ | /var/log/smartdns/audit.log |
          | \`--mode\` | \`-m\` | éƒ¨ç½²æ¨¡å¼ (systemd/docker) | âŒ | systemd |
          | \`--uninstall\` | - | å¸è½½æœåŠ¡ | - | - |
          | \`--help\` | \`-h\` | æ˜¾ç¤ºå¸®åŠ© | - | - |
          ### ğŸ› ï¸ ç®¡ç†å‘½ä»¤
          \`\`\`bash
          # æŸ¥çœ‹å¸®åŠ©
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | bash -s -- --help
          # systemd æ¨¡å¼ç®¡ç†
          sudo systemctl status smartdns-log-agent      # æŸ¥çœ‹çŠ¶æ€
          sudo systemctl restart smartdns-log-agent     # é‡å¯æœåŠ¡
          sudo journalctl -u smartdns-log-agent -f      # æŸ¥çœ‹æ—¥å¿—
          # Docker æ¨¡å¼ç®¡ç†
          cd /opt/smartdns-log-agent && docker-compose ps        # æŸ¥çœ‹çŠ¶æ€
          cd /opt/smartdns-log-agent && docker-compose restart   # é‡å¯æœåŠ¡
          cd /opt/smartdns-log-agent && docker-compose logs -f   # æŸ¥çœ‹æ—¥å¿—
          # å¸è½½
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- --uninstall
          \`\`\`
          ### ğŸ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹
          \`\`\`bash
          # åœºæ™¯1: æœ¬åœ°æµ‹è¯•
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \\
            -n 1 -H localhost -p "test123"
          # åœºæ™¯2: ç”Ÿäº§ç¯å¢ƒ
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \\
            -n 1 -N "prod-server-01" -H 192.168.1.100 -P 9000 -p "prod_password" -l /var/log/smartdns/query.log
          # åœºæ™¯3: è‡ªå®šä¹‰é…ç½®
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \\
            -n 2 -N "backup-node" -H clickhouse.example.com -P 9001 -d custom_logs -u admin -p "secret123"
          \`\`\`
          EOF
          
          # æ·»åŠ åŒ…ä¿¡æ¯
          if [ $file_count -gt 0 ]; then
            cat >> release-notes.md << EOF
          ### ğŸ“¦ å¯ç”¨å¹³å° ($file_count ä¸ªåŒ…)
          - **Linux**: amd64, arm64, armv7
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon) 
          - **Windows**: amd64
          > æ¨èä½¿ç”¨ä¸Šæ–¹çš„ä¸€é”®å®‰è£…è„šæœ¬,ä¼šè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæ¶æ„å¹¶ä¸‹è½½å¯¹åº”ç‰ˆæœ¬
          EOF
          else
            cat >> release-notes.md << EOF
          ### â³ å‘å¸ƒåŒ…æ„å»ºä¸­...
          äºŒè¿›åˆ¶æ–‡ä»¶å’Œå®‰è£…åŒ…æ­£åœ¨åå°æ„å»º,è¯·:
          1. ç¨ååˆ·æ–°æ­¤é¡µé¢æŸ¥çœ‹å®Œæ•´åŒ…
          2. æˆ–ä» [Actions](https://github.com/${{ github.repository }}/actions) é¡µé¢ç›´æ¥ä¸‹è½½
          3. æ¨èç›´æ¥ä½¿ç”¨ä¸Šæ–¹çš„ä¸€é”®å®‰è£…è„šæœ¬
          ### ğŸ“¦ å³å°†æ”¯æŒçš„å¹³å°
          - **Linux**: amd64, arm64, armv7
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          - **Windows**: amd64
          EOF
          fi
          
          # æ·»åŠ æ„å»ºæ—¶é—´å’Œç‰ˆæœ¬ä¿¡æ¯
          echo "" >> release-notes.md
          echo "---" >> release-notes.md
          echo "*æ„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> release-notes.md
          echo "*ç‰ˆæœ¬: ${{ needs.generate-version.outputs.new_version }}*" >> release-notes.md
          echo "*ç‰ˆæœ¬å·: ${{ needs.generate-version.outputs.version_number }}*" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.generate-version.outputs.new_version }}
          name: SmartDNS Log Agent ${{ needs.generate-version.outputs.new_version }}
          body_path: release-notes.md
          files: releases/*
          draft: false
          prerelease: ${{ contains(needs.generate-version.outputs.new_version, 'rc') || contains(needs.generate-version.outputs.new_version, 'beta') || contains(needs.generate-version.outputs.new_version, 'alpha') }}
          generate_release_notes: true
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old artifacts
        if: success()
        run: |
          echo "ğŸ§¹ Cleaning up intermediate artifacts..."
          echo "âœ… Release ${{ needs.generate-version.outputs.new_version }} creation completed successfully!"