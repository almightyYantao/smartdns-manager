name: Build and Release
on:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  BINARY_NAME: smartdns-log-agent
  AGENT_DIR: agent
jobs:
  build-binaries:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
          - goos: linux
            goarch: arm
            goarm: 7
            suffix: linux-armv7
          - goos: darwin
            goarch: amd64
            suffix: darwin-amd64
          - goos: darwin
            goarch: arm64
            suffix: darwin-arm64
          - goos: windows
            goarch: amd64
            suffix: windows-amd64.exe

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('agent/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build binary
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          # è¿›å…¥ agent ç›®å½•
          cd ${{ env.AGENT_DIR }}
          
          # æž„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
          if [ "${{ matrix.goos }}" = "windows" ]; then
            go build -ldflags "-s -w -X main.Version=${{ github.ref_name || github.sha }}" -o ../${{ env.BINARY_NAME }}-${{ matrix.suffix }} main.go
          else
            go build -ldflags "-s -w -X main.Version=${{ github.ref_name || github.sha }}" -o ../${{ env.BINARY_NAME }}-${{ matrix.suffix }} main.go
          fi
          
          # è¿”å›žæ ¹ç›®å½•
          cd ..
          
          # éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
          if [ "${{ matrix.goos }}" != "windows" ]; then
            file ${{ env.BINARY_NAME }}-${{ matrix.suffix }}
          fi

      - name: Create release package
        run: |
          # åˆ›å»ºå‘å¸ƒåŒ…ç›®å½•
          mkdir -p release-${{ matrix.suffix }}
          
          # å¤åˆ¶äºŒè¿›åˆ¶æ–‡ä»¶
          cp ${{ env.BINARY_NAME }}-${{ matrix.suffix }} release-${{ matrix.suffix }}/
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶å’Œè„šæœ¬
          cp ${{ env.AGENT_DIR }}/docker-compose.yml release-${{ matrix.suffix }}/
          cp ${{ env.AGENT_DIR }}/install.sh release-${{ matrix.suffix }}/
          cp ${{ env.AGENT_DIR }}/smartdns-log-agent.service release-${{ matrix.suffix }}/
          cp ${{ env.AGENT_DIR }}/config.env release-${{ matrix.suffix }}/
          cp ${{ env.AGENT_DIR }}/README.md release-${{ matrix.suffix }}/README.md
          
          # å¦‚æžœæ²¡æœ‰ manage.sh æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªç®€å•çš„ç®¡ç†è„šæœ¬
          if [ ! -f "${{ env.AGENT_DIR }}/manage.sh" ]; then
            cat > release-${{ matrix.suffix }}/manage.sh << 'EOF'
          #!/bin/bash
          
          SERVICE_NAME="smartdns-log-agent"
          BINARY_NAME="smartdns-log-agent"
          
          case "$1" in
              start)
                  echo "Starting $SERVICE_NAME..."
                  sudo systemctl start $SERVICE_NAME
                  ;;
              stop)
                  echo "Stopping $SERVICE_NAME..."
                  sudo systemctl stop $SERVICE_NAME
                  ;;
              restart)
                  echo "Restarting $SERVICE_NAME..."
                  sudo systemctl restart $SERVICE_NAME
                  ;;
              status)
                  sudo systemctl status $SERVICE_NAME
                  ;;
              logs)
                  sudo journalctl -u $SERVICE_NAME -f
                  ;;
              install)
                  echo "Installing $SERVICE_NAME..."
                  sudo cp $BINARY_NAME /usr/local/bin/
                  sudo chmod +x /usr/local/bin/$BINARY_NAME
                  sudo cp $SERVICE_NAME.service /etc/systemd/system/
                  sudo systemctl daemon-reload
                  sudo systemctl enable $SERVICE_NAME
                  echo "Installation completed. Use 'sudo ./manage.sh start' to start the service."
                  ;;
              uninstall)
                  echo "Uninstalling $SERVICE_NAME..."
                  sudo systemctl stop $SERVICE_NAME
                  sudo systemctl disable $SERVICE_NAME
                  sudo rm -f /etc/systemd/system/$SERVICE_NAME.service
                  sudo rm -f /usr/local/bin/$BINARY_NAME
                  sudo systemctl daemon-reload
                  echo "Uninstallation completed."
                  ;;
              *)
                  echo "Usage: $0 {start|stop|restart|status|logs|install|uninstall}"
                  exit 1
                  ;;
          esac
          EOF
            chmod +x release-${{ matrix.suffix }}/manage.sh
          else
            cp ${{ env.AGENT_DIR }}/manage.sh release-${{ matrix.suffix }}/
            chmod +x release-${{ matrix.suffix }}/manage.sh
          fi
          
          # åˆ›å»ºè¯¦ç»†çš„å®‰è£…è¯´æ˜Ž
          cat > release-${{ matrix.suffix }}/INSTALL.md << 'EOF'
          # SmartDNS Log Agent å®‰è£…æŒ‡å—
          
          ## å¿«é€Ÿå®‰è£…ï¼ˆæŽ¨èï¼‰
          
          ### 1. ä½¿ç”¨ç®¡ç†è„šæœ¬å®‰è£…
          ```bash
          # è§£åŽ‹å‘å¸ƒåŒ…
          tar -xzf smartdns-log-agent-*.tar.gz
          cd smartdns-log-agent-*/
          
          # å®‰è£…æœåŠ¡
          sudo ./manage.sh install
          
          # é…ç½®çŽ¯å¢ƒå˜é‡ï¼ˆå¯é€‰ï¼‰
          sudo nano /etc/smartdns-log-agent/config
          
          # å¯åŠ¨æœåŠ¡
          sudo ./manage.sh start
          
          # æŸ¥çœ‹çŠ¶æ€
          sudo ./manage.sh status
          
          # æŸ¥çœ‹æ—¥å¿—
          sudo ./manage.sh logs
          ```
          
          ### 2. ä½¿ç”¨å®‰è£…è„šæœ¬
          ```bash
          # å¦‚æžœå­˜åœ¨ install.sh è„šæœ¬
          sudo bash install.sh
          ```
          
          ## Docker éƒ¨ç½²
          
          ### ä½¿ç”¨ docker-compose
          ```bash
          # ç¼–è¾‘çŽ¯å¢ƒå˜é‡
          cat > .env << 'EOL'
          NODE_ID=1
          NODE_NAME=node-1
          LOG_FILE=/var/log/smartdns/smartdns.log
          CLICKHOUSE_HOST=your-clickhouse-host
          CLICKHOUSE_PORT=9000
          CLICKHOUSE_DB=smartdns_logs
          CLICKHOUSE_USER=default
          CLICKHOUSE_PASSWORD=your-password
          BATCH_SIZE=1000
          FLUSH_INTERVAL_SEC=2
          EOL
          
          # å¯åŠ¨æœåŠ¡
          docker-compose up -d
          
          # æŸ¥çœ‹æ—¥å¿—
          docker-compose logs -f
          ```
          
          ### ç›´æŽ¥ä½¿ç”¨ Docker
          ```bash
          docker run -d \
            --name smartdns-log-agent \
            -e NODE_ID=1 \
            -e CLICKHOUSE_HOST=your-host \
            -e CLICKHOUSE_PASSWORD=your-password \
            -v /var/log/smartdns:/var/log/smartdns:ro \
            ghcr.io/your-repo/smartdns-log-agent:latest
          ```
          
          ## æ‰‹åŠ¨å®‰è£…
          
          ### 1. å®‰è£…äºŒè¿›åˆ¶æ–‡ä»¶
          ```bash
          sudo cp smartdns-log-agent-* /usr/local/bin/smartdns-log-agent
          sudo chmod +x /usr/local/bin/smartdns-log-agent
          ```
          
          ### 2. åˆ›å»ºç³»ç»Ÿç”¨æˆ·
          ```bash
          sudo useradd -r -s /bin/false smartdns-log-agent
          ```
          
          ### 3. åˆ›å»ºé…ç½®ç›®å½•å’Œæ–‡ä»¶
          ```bash
          sudo mkdir -p /etc/smartdns-log-agent
          sudo cp config.env /etc/smartdns-log-agent/config
          sudo chown -R smartdns-log-agent:smartdns-log-agent /etc/smartdns-log-agent
          ```
          
          ### 4. å®‰è£… systemd æœåŠ¡
          ```bash
          sudo cp smartdns-log-agent.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable smartdns-log-agent
          ```
          
          ### 5. å¯åŠ¨æœåŠ¡
          ```bash
          sudo systemctl start smartdns-log-agent
          sudo systemctl status smartdns-log-agent
          ```
          
          ## é…ç½®è¯´æ˜Ž
          
          ### çŽ¯å¢ƒå˜é‡
          ç¼–è¾‘ `/etc/smartdns-log-agent/config` æˆ–è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼š
          
          ```bash
          # èŠ‚ç‚¹é…ç½®
          NODE_ID=1                           # èŠ‚ç‚¹ID
          NODE_NAME=node-1                    # èŠ‚ç‚¹åç§°
          
          # æ—¥å¿—æ–‡ä»¶
          LOG_FILE=/var/log/smartdns/smartdns.log  # SmartDNS æ—¥å¿—æ–‡ä»¶è·¯å¾„
          
          # ClickHouse é…ç½®
          CLICKHOUSE_HOST=localhost           # ClickHouse ä¸»æœº
          CLICKHOUSE_PORT=9000                # ClickHouse ç«¯å£
          CLICKHOUSE_DB=smartdns_logs         # æ•°æ®åº“å
          CLICKHOUSE_USER=default             # ç”¨æˆ·å
          CLICKHOUSE_PASSWORD=                # å¯†ç 
          
          # æ‰¹å¤„ç†é…ç½®
          BATCH_SIZE=1000                     # æ‰¹å¤„ç†å¤§å°
          FLUSH_INTERVAL_SEC=2                # åˆ·æ–°é—´éš”ï¼ˆç§’ï¼‰
          ```
          
          ## æ•…éšœæŽ’é™¤
          
          ### æŸ¥çœ‹æ—¥å¿—
          ```bash
          # systemd æ—¥å¿—
          sudo journalctl -u smartdns-log-agent -f
          
          # æˆ–ä½¿ç”¨ç®¡ç†è„šæœ¬
          sudo ./manage.sh logs
          ```
          
          ### æ£€æŸ¥æœåŠ¡çŠ¶æ€
          ```bash
          sudo systemctl status smartdns-log-agent
          ```
          
          ### æµ‹è¯•è¿žæŽ¥
          ```bash
          # æµ‹è¯• ClickHouse è¿žæŽ¥
          echo "SELECT 1" | clickhouse-client --host=your-host --port=9000
          
          # æ£€æŸ¥ SmartDNS æ—¥å¿—æ–‡ä»¶
          ls -la /var/log/smartdns/smartdns.log
          ```
          
          ### å¸¸è§é—®é¢˜
          
          1. **æƒé™é—®é¢˜**: ç¡®ä¿ smartdns-log-agent ç”¨æˆ·æœ‰æƒé™è¯»å– SmartDNS æ—¥å¿—æ–‡ä»¶
          2. **ç½‘ç»œé—®é¢˜**: ç¡®ä¿èƒ½è¿žæŽ¥åˆ° ClickHouse æœåŠ¡å™¨
          3. **é…ç½®é—®é¢˜**: æ£€æŸ¥çŽ¯å¢ƒå˜é‡é…ç½®æ˜¯å¦æ­£ç¡®
          
          ## å¸è½½
          
          ### ä½¿ç”¨ç®¡ç†è„šæœ¬
          ```bash
          sudo ./manage.sh uninstall
          ```
          
          ### æ‰‹åŠ¨å¸è½½
          ```bash
          sudo systemctl stop smartdns-log-agent
          sudo systemctl disable smartdns-log-agent
          sudo rm -f /etc/systemd/system/smartdns-log-agent.service
          sudo rm -f /usr/local/bin/smartdns-log-agent
          sudo rm -rf /etc/smartdns-log-agent
          sudo userdel smartdns-log-agent
          sudo systemctl daemon-reload
          ```
          EOF
          
          # æ‰“åŒ…
          tar -czf ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz -C release-${{ matrix.suffix }} .

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}
          path: |
            ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz
            ${{ env.BINARY_NAME }}-${{ matrix.suffix }}
          retention-days: 90
          compression-level: 6

  build-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push image
        uses: docker/build-push-action@v5
        with:
          context: ./agent
          file: ./agent/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64
          build-args: |
            VERSION=${{ github.ref_name || github.sha }}

  release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: [build-binaries, build-docker]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ env.BINARY_NAME }}-*
          merge-multiple: false

      - name: Prepare release files
        run: |
          # åˆ›å»º releases ç›®å½•
          mkdir -p releases
          
          # ç§»åŠ¨æ‰€æœ‰ tar.gz æ–‡ä»¶åˆ° releases ç›®å½•
          find . -name "*.tar.gz" -exec mv {} releases/ \;
          
          # åˆ—å‡ºæ–‡ä»¶ç¡®è®¤
          ls -la releases/

      - name: Create release notes
        run: |
          cat > release-notes.md << 'EOF'
          ## SmartDNS Log Agent ${{ github.ref_name }}
          
          é«˜æ€§èƒ½çš„ SmartDNS æ—¥å¿—æ”¶é›†å’Œåˆ†æžä»£ç†ï¼Œæ”¯æŒå®žæ—¶æ—¥å¿—æ”¶é›†ã€æ‰¹é‡å¤„ç†å’Œ ClickHouse å­˜å‚¨ã€‚
          
          ### âœ¨ ä¸»è¦ç‰¹æ€§
          
          - ðŸš€ **é«˜æ€§èƒ½**: å¼‚æ­¥æ—¥å¿—å¤„ç†ï¼Œæ”¯æŒå¤§é‡å¹¶å‘
          - ðŸ“Š **å®žæ—¶ç›‘æŽ§**: å®žæ—¶æ”¶é›† SmartDNS æ—¥å¿—å¹¶å­˜å‚¨åˆ° ClickHouse
          - ðŸ³ **å®¹å™¨åŒ–**: æ”¯æŒ Docker å’Œ docker-compose éƒ¨ç½²
          - ðŸ”§ **æ˜“äºŽç®¡ç†**: æä¾› systemd æœåŠ¡å’Œç®¡ç†è„šæœ¬
          - ðŸ”„ **è‡ªåŠ¨é‡è¿ž**: ç½‘ç»œä¸­æ–­è‡ªåŠ¨é‡è¿žï¼Œç¡®ä¿æ•°æ®ä¸ä¸¢å¤±
          - ðŸ“¦ **æ‰¹é‡å¤„ç†**: å¯é…ç½®æ‰¹é‡å¤§å°å’Œåˆ·æ–°é—´éš”
          
          ### ðŸ—ï¸ æ”¯æŒæž¶æž„
          
          | å¹³å° | æž¶æž„ | æ–‡ä»¶å |
          |------|------|--------|
          | Linux | x86_64 | `smartdns-log-agent-linux-amd64.tar.gz` |
          | Linux | ARM64 | `smartdns-log-agent-linux-arm64.tar.gz` |
          | Linux | ARMv7 | `smartdns-log-agent-linux-armv7.tar.gz` |
          | macOS | Intel | `smartdns-log-agent-darwin-amd64.tar.gz` |
          | macOS | Apple Silicon | `smartdns-log-agent-darwin-arm64.tar.gz` |
          | Windows | x86_64 | `smartdns-log-agent-windows-amd64.exe.tar.gz` |
          
          ### ðŸš€ å¿«é€Ÿå¼€å§‹
          
          #### 1. ä¸‹è½½å¹¶å®‰è£…
          ```bash
          # ä¸‹è½½å¯¹åº”å¹³å°çš„åŒ…
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/smartdns-log-agent-linux-amd64.tar.gz
          
          # è§£åŽ‹
          tar -xzf smartdns-log-agent-linux-amd64.tar.gz
          cd smartdns-log-agent-linux-amd64/
          
          # å¿«é€Ÿå®‰è£…
          sudo ./manage.sh install
          
          # é…ç½®ï¼ˆå¯é€‰ï¼‰
          sudo nano /etc/smartdns-log-agent/config
          
          # å¯åŠ¨æœåŠ¡
          sudo ./manage.sh start
          ```
          
          #### 2. Docker éƒ¨ç½²
          ```bash
          # ä½¿ç”¨ Docker Compose
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/smartdns-log-agent-linux-amd64.tar.gz
          tar -xzf smartdns-log-agent-linux-amd64.tar.gz
          cd smartdns-log-agent-linux-amd64/
          
          # ç¼–è¾‘çŽ¯å¢ƒå˜é‡
          nano .env
          
          # å¯åŠ¨
          docker-compose up -d
          ```
          
          #### 3. ç›´æŽ¥è¿è¡Œ Docker é•œåƒ
          ```bash
          docker run -d \
            --name smartdns-log-agent \
            -e NODE_ID=1 \
            -e CLICKHOUSE_HOST=your-clickhouse-host \
            -e CLICKHOUSE_PASSWORD=your-password \
            -v /var/log/smartdns:/var/log/smartdns:ro \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          ```
          
          ### ðŸ“– æ–‡æ¡£
          
          æ¯ä¸ªå‘å¸ƒåŒ…éƒ½åŒ…å«è¯¦ç»†çš„å®‰è£…å’Œé…ç½®è¯´æ˜Žï¼š
          - `README.md` - åŸºæœ¬è¯´æ˜Ž
          - `INSTALL.md` - è¯¦ç»†å®‰è£…æŒ‡å—
          - `config.env` - é…ç½®æ–‡ä»¶æ¨¡æ¿
          - `manage.sh` - æœåŠ¡ç®¡ç†è„šæœ¬
          
          ### ðŸ› é—®é¢˜åé¦ˆ
          
          å¦‚æžœé‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š
          1. æŸ¥çœ‹æ—¥å¿—ï¼š`sudo ./manage.sh logs`
          2. æ£€æŸ¥é…ç½®ï¼šç¡®ä¿ ClickHouse è¿žæŽ¥æ­£å¸¸
          3. æäº¤ Issueï¼šåŒ…å«æ—¥å¿—å’Œé…ç½®ä¿¡æ¯
          
          ### ðŸ“ æ›´æ–°æ—¥å¿—
          
          è¯¦ç»†çš„æ›´æ–°å†…å®¹è¯·æŸ¥çœ‹ä¸‹æ–¹çš„è‡ªåŠ¨ç”Ÿæˆçš„æ›´æ–°æ—¥å¿—ã€‚
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: SmartDNS Log Agent ${{ github.ref_name }}
          body_path: release-notes.md
          files: releases/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          generate_release_notes: true
          make_latest: true