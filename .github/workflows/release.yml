name: Create Release
on:
  push:
    tags:
      - 'agent-v*'

env:
  BINARY_NAME: smartdns-log-agent

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for builds to complete dynamically
        run: |
          echo "Dynamically waiting for builds to complete..."
          
          # èŽ·å–å½“å‰ commit SHA
          COMMIT_SHA="${{ github.sha }}"
          REPO="${{ github.repository }}"
          
          # éœ€è¦ç­‰å¾…çš„ workflows
          WORKFLOWS=("Build Binaries" "Create Release Packages")
          
          # ç­‰å¾…å‡½æ•°
          wait_for_workflow() {
            local workflow_name="$1"
            local max_wait=1200  # æœ€å¤§ç­‰å¾…20åˆ†é’Ÿ
            local check_interval=30  # æ¯30ç§’æ£€æŸ¥ä¸€æ¬¡
            local waited=0
          
            echo "â³ Waiting for '$workflow_name' to complete..."
          
            while [ $waited -lt $max_wait ]; do
              # èŽ·å–è¯¥ workflow åœ¨å½“å‰ commit çš„è¿è¡ŒçŠ¶æ€
              runs=$(gh api "repos/$REPO/actions/runs" \
                --jq ".workflow_runs[] | select(.head_sha == \"$COMMIT_SHA\" and .name == \"$workflow_name\") | .status" \
                2>/dev/null || echo "")
          
              if echo "$runs" | grep -q "completed"; then
                # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
                conclusion=$(gh api "repos/$REPO/actions/runs" \
                  --jq ".workflow_runs[] | select(.head_sha == \"$COMMIT_SHA\" and .name == \"$workflow_name\") | .conclusion" \
                  2>/dev/null || echo "")
          
                if echo "$conclusion" | grep -q "success"; then
                  echo "âœ… '$workflow_name' completed successfully!"
                  return 0
                else
                  echo "âŒ '$workflow_name' completed but failed. Conclusion: $conclusion"
                  return 1
                fi
              elif echo "$runs" | grep -q "in_progress"; then
                echo "ðŸ”„ '$workflow_name' is still running... (waited ${waited}s)"
              else
                echo "ðŸ” '$workflow_name' not found or not started yet... (waited ${waited}s)"
              fi
          
              sleep $check_interval
              waited=$((waited + check_interval))
            done
          
            echo "â° Timeout waiting for '$workflow_name' (waited ${waited}s)"
            return 1
          }
          
          # ç­‰å¾…æ‰€æœ‰å¿…è¦çš„ workflows
          all_success=true
          for workflow in "${WORKFLOWS[@]}"; do
            if ! wait_for_workflow "$workflow"; then
              echo "âš ï¸  Warning: '$workflow' did not complete successfully"
              all_success=false
            fi
          done
          
          if [ "$all_success" = true ]; then
            echo "ðŸŽ‰ All workflows completed successfully!"
          else
            echo "âš ï¸  Some workflows failed, but continuing with release creation..."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download artifacts with smart retry
        run: |
          echo "ðŸ“¦ Downloading artifacts..."
          
          download_artifact() {
            local artifact_name="$1"
            local max_attempts=5
            local attempt=1
          
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts: Downloading $artifact_name..."
          
              if gh run download --name "$artifact_name" 2>/dev/null; then
                echo "âœ… Successfully downloaded $artifact_name"
                return 0
              else
                echo "âŒ Failed to download $artifact_name (attempt $attempt)"
                if [ $attempt -lt $max_attempts ]; then
                  sleep 10
                fi
              fi
          
              attempt=$((attempt + 1))
            done
          
            echo "âš ï¸  Failed to download $artifact_name after $max_attempts attempts"
            return 1
          }
          
          # å°è¯•ä¸‹è½½æ‰€æœ‰åŒ…
          packages=("linux-amd64" "linux-arm64" "linux-armv7" "darwin-amd64" "darwin-arm64" "windows-amd64.exe")
          downloaded_count=0
          
          for suffix in "${packages[@]}"; do
            if download_artifact "package-$suffix"; then
              downloaded_count=$((downloaded_count + 1))
            fi
          done
          
          echo "ðŸ“Š Downloaded $downloaded_count out of ${#packages[@]} packages"
          
          # å¦‚æžœæ²¡æœ‰ä¸‹è½½åˆ°ä»»ä½•åŒ…ï¼Œå°è¯•ä¸‹è½½äºŒè¿›åˆ¶æ–‡ä»¶
          if [ $downloaded_count -eq 0 ]; then
            echo "ðŸ”„ No packages found, trying to download binaries..."
            for suffix in "${packages[@]}"; do
              download_artifact "binary-$suffix"
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare release files
        run: |
          mkdir -p releases
          
          # æŸ¥æ‰¾ tar.gz åŒ…æ–‡ä»¶
          find . -name "*.tar.gz" -exec cp {} releases/ \; 2>/dev/null || true
          
          # å¦‚æžœæ²¡æœ‰åŒ…æ–‡ä»¶ï¼Œä½†æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¿«é€Ÿåˆ›å»ºåŒ…
          if [ $(ls releases/*.tar.gz 2>/dev/null | wc -l) -eq 0 ]; then
            echo "ðŸ“¦ No packages found, creating packages from binaries..."
          
            for binary in ${{ env.BINARY_NAME }}-*; do
              if [ -f "$binary" ]; then
                suffix=${binary#${{ env.BINARY_NAME }}-}
                echo "Creating package for $suffix..."
          
                mkdir -p "temp-$suffix"
                cp "$binary" "temp-$suffix/"
          
                # åˆ›å»ºç®€å•çš„å®‰è£…è„šæœ¬
                cat > "temp-$suffix/install.sh" << 'EOF'
          #!/bin/bash
          echo "Installing SmartDNS Log Agent..."
          sudo cp smartdns-log-agent-* /usr/local/bin/smartdns-log-agent 2>/dev/null || sudo cp smartdns-log-agent /usr/local/bin/
          sudo chmod +x /usr/local/bin/smartdns-log-agent
          echo "Installation completed!"
          EOF
                chmod +x "temp-$suffix/install.sh"
          
                tar -czf "releases/${{ env.BINARY_NAME }}-$suffix.tar.gz" -C "temp-$suffix" .
                rm -rf "temp-$suffix"
              fi
            done
          fi
          
          # ç»Ÿè®¡ç»“æžœ
          file_count=$(ls releases/*.tar.gz 2>/dev/null | wc -l)
          echo "ðŸ“Š Final release files count: $file_count"
          
          if [ $file_count -gt 0 ]; then
            echo "ðŸ“‹ Release files:"
            ls -la releases/
          else
            echo "âš ï¸  No release files created, adding placeholder"
            touch releases/README.txt
            echo "Release packages are being built. Please check the Actions tab." > releases/README.txt
          fi

      - name: Generate dynamic release notes
        run: |
          file_count=$(ls releases/*.tar.gz 2>/dev/null | wc -l)

          cat > release-notes.md << 'EOF'
          ## SmartDNS Log Agent ${{ github.ref_name }}

          é«˜æ€§èƒ½çš„ SmartDNS æ—¥å¿—æ”¶é›†å’Œåˆ†æžä»£ç†ã€‚

          ### ðŸš€ å¿«é€Ÿå®‰è£…

          > **æ³¨æ„**: éœ€è¦ root æƒé™ï¼Œè¯·æ›¿æ¢å®žé™…çš„èŠ‚ç‚¹IDã€ClickHouseåœ°å€å’Œå¯†ç 

          ```bash
          # ä¸€é”®å®‰è£…ï¼ˆæŽ¨èæ–¹å¼ï¼‰
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- -n [èŠ‚ç‚¹ID] -H [ClickHouseåœ°å€] -p "[å¯†ç ]"

          # ç¤ºä¾‹
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- -n 1 -H 192.168.1.100 -p "mypassword"
          ```

          ### ðŸ³ Docker æ¨¡å¼

          ```bash
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- -n 1 -H 192.168.1.100 -p "password" -m docker
          ```

          ### ðŸ”§ å®Œæ•´å‚æ•°å®‰è£…

          ```bash
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \
            -n 1 \
            -N "my-node" \
            -H 192.168.1.100 \
            -P 9000 \
            -d smartdns_logs \
            -u default \
            -p "your_password" \
            -l /var/log/audit/audit.log \
            -m systemd
          ```

          ### ðŸ“‹ å‚æ•°è¯´æ˜Ž

          | å‚æ•° | ç®€å†™ | è¯´æ˜Ž | å¿…éœ€ | é»˜è®¤å€¼ |
          |------|------|------|------|--------|
          | `--node-id` | `-n` | èŠ‚ç‚¹ID | âœ… | - |
          | `--clickhouse-host` | `-H` | ClickHouseä¸»æœºåœ°å€ | âœ… | - |
          | `--node-name` | `-N` | èŠ‚ç‚¹åç§° | âŒ | node-ID |
          | `--clickhouse-port` | `-P` | ClickHouseç«¯å£ | âŒ | 9000 |
          | `--clickhouse-db` | `-d` | æ•°æ®åº“å | âŒ | smartdns_logs |
          | `--clickhouse-user` | `-u` | ç”¨æˆ·å | âŒ | default |
          | `--clickhouse-password` | `-p` | å¯†ç  | âŒ | - |
          | `--log-file` | `-l` | æ—¥å¿—æ–‡ä»¶è·¯å¾„ | âŒ | /var/log/audit/audit.log |
          | `--mode` | `-m` | éƒ¨ç½²æ¨¡å¼ (systemd/docker) | âŒ | systemd |
          | `--uninstall` | - | å¸è½½æœåŠ¡ | - | - |
          | `--help` | `-h` | æ˜¾ç¤ºå¸®åŠ© | - | - |

          ### ðŸ› ï¸ ç®¡ç†å‘½ä»¤

          ```bash
          # æŸ¥çœ‹å¸®åŠ©
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | bash -s -- --help

          # systemd æ¨¡å¼ç®¡ç†
          sudo systemctl status smartdns-log-agent      # æŸ¥çœ‹çŠ¶æ€
          sudo systemctl restart smartdns-log-agent     # é‡å¯æœåŠ¡
          sudo journalctl -u smartdns-log-agent -f      # æŸ¥çœ‹æ—¥å¿—

          # Docker æ¨¡å¼ç®¡ç†
          cd /opt/smartdns-log-agent && docker-compose ps        # æŸ¥çœ‹çŠ¶æ€
          cd /opt/smartdns-log-agent && docker-compose restart   # é‡å¯æœåŠ¡
          cd /opt/smartdns-log-agent && docker-compose logs -f   # æŸ¥çœ‹æ—¥å¿—

          # å¸è½½
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- --uninstall
          ```

          ### ðŸŽ¯ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

          ```bash
          # åœºæ™¯1: æœ¬åœ°æµ‹è¯•
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \
            -n 1 -H localhost -p "test123"

          # åœºæ™¯2: ç”Ÿäº§çŽ¯å¢ƒ
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \
            -n 1 -N "prod-server-01" -H 192.168.1.100 -P 9000 -p "prod_password" -l /var/log/smartdns/query.log

          # åœºæ™¯3: è‡ªå®šä¹‰é…ç½®
          curl -fsSL https://raw.githubusercontent.com/almightyyantao/smartdns-manager/main/agent/install.sh | sudo bash -s -- \
            -n 2 -N "backup-node" -H clickhouse.example.com -P 9001 -d custom_logs -u admin -p "secret123"
          ```

          ---
          EOF

          # æ·»åŠ åŒ…ä¿¡æ¯
          if [ $file_count -gt 0 ]; then
            cat >> release-notes.md << EOF
          ### ðŸ“¦ å¯ç”¨å¹³å° ($file_count ä¸ªåŒ…)

          - **Linux**: amd64, arm64, armv7
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          - **Windows**: amd64

          > æŽ¨èä½¿ç”¨ä¸Šæ–¹çš„ä¸€é”®å®‰è£…è„šæœ¬ï¼Œä¼šè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæž¶æž„å¹¶ä¸‹è½½å¯¹åº”ç‰ˆæœ¬

          EOF
          else
            cat >> release-notes.md << EOF
          ### â³ å‘å¸ƒåŒ…æž„å»ºä¸­...

          äºŒè¿›åˆ¶æ–‡ä»¶å’Œå®‰è£…åŒ…æ­£åœ¨åŽå°æž„å»ºï¼Œè¯·ï¼š
          1. ç¨åŽåˆ·æ–°æ­¤é¡µé¢æŸ¥çœ‹å®Œæ•´åŒ…
          2. æˆ–ä»Ž [Actions](https://github.com/${{ github.repository }}/actions) é¡µé¢ç›´æŽ¥ä¸‹è½½
          3. æŽ¨èç›´æŽ¥ä½¿ç”¨ä¸Šæ–¹çš„ä¸€é”®å®‰è£…è„šæœ¬

          ### ðŸ“¦ å³å°†æ”¯æŒçš„å¹³å°

          - **Linux**: amd64, arm64, armv7
          - **macOS**: amd64 (Intel), arm64 (Apple Silicon)
          - **Windows**: amd64

          EOF
          fi

          # æ·»åŠ æž„å»ºæ—¶é—´å’Œç‰ˆæœ¬ä¿¡æ¯
          echo "---" >> release-notes.md
          echo "*æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')*" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: SmartDNS Log Agent ${{ github.ref_name }}
          body_path: release-notes.md
          files: releases/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          generate_release_notes: true
          make_latest: true