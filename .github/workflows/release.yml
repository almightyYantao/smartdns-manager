name: Create Release
on:
  push:
    tags:
      - 'v*'

env:
  BINARY_NAME: smartdns-log-agent

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # åªç­‰å¾…äºŒè¿›åˆ¶æž„å»ºå’Œæ‰“åŒ…å®Œæˆ
      - name: Wait for binaries and packages to complete
        run: |
          echo "Waiting for binary builds and package creation to complete..."
          
          # ç­‰å¾…å‡½æ•°
          wait_for_workflow() {
            local workflow_name=$1
            local max_attempts=20  # å‡å°‘ç­‰å¾…æ—¶é—´
            local attempt=1
          
            while [ $attempt -le $max_attempts ]; do
              echo "Checking $workflow_name (attempt $attempt/$max_attempts)..."
          
              # èŽ·å–å½“å‰ commit çš„ workflow runs
              runs=$(gh api repos/${{ github.repository }}/actions/runs \
                --jq ".workflow_runs[] | select(.head_sha == \"${{ github.sha }}\" and .name == \"$workflow_name\") | .status")
          
              if echo "$runs" | grep -q "completed"; then
                echo "$workflow_name completed!"
                return 0
              fi
          
              sleep 20
              attempt=$((attempt + 1))
            done
          
            echo "Warning: $workflow_name did not complete within timeout"
            return 1
          }
          
          # åªç­‰å¾…ç›¸å…³çš„ workflows
          wait_for_workflow "Build Binaries" || echo "Build Binaries not found or incomplete"
          wait_for_workflow "Create Release Packages" || echo "Create Release Packages not found or incomplete"
          
          echo "Proceeding with release creation..."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download all package artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: package-*
          merge-multiple: false
        continue-on-error: true

      - name: Prepare release files
        run: |
          mkdir -p releases
          
          # æŸ¥æ‰¾æ‰€æœ‰ tar.gz æ–‡ä»¶
          find . -name "*.tar.gz" -exec mv {} releases/ \; 2>/dev/null || true
          
          # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°äº†æ–‡ä»¶
          file_count=$(ls releases/*.tar.gz 2>/dev/null | wc -l)
          
          if [ $file_count -eq 0 ]; then
            echo "Warning: No package files found"
            echo "This might be because:"
            echo "1. Build workflows are still running"
            echo "2. Build failed"
            echo "3. Artifact names don't match pattern 'package-*'"
          
            echo "Available artifacts:"
            find . -name "*.tar.gz" -o -name "*artifact*" | head -20
          
            # åˆ›å»ºå ä½ç¬¦æ–‡ä»¶
            touch releases/README.txt
            echo "Release packages are being built and will be available shortly." > releases/README.txt
            echo "Please check the Actions tab for build progress." >> releases/README.txt
          else
            echo "Found $file_count release files:"
            ls -la releases/
          fi

      - name: Generate release notes
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰å®žé™…çš„åŒ…æ–‡ä»¶
          if [ -f releases/README.txt ]; then
            # å¦‚æžœåªæœ‰å ä½ç¬¦æ–‡ä»¶ï¼Œåˆ›å»ºç®€åŒ–çš„è¯´æ˜Ž
            cat > release-notes.md << 'EOF'
          ## SmartDNS Log Agent ${{ github.ref_name }}
          
          â³ **å‘å¸ƒåŒ…æ­£åœ¨æž„å»ºä¸­...**
          
          äºŒè¿›åˆ¶æ–‡ä»¶å’Œå®‰è£…åŒ…æ­£åœ¨åŽå°æž„å»ºï¼Œè¯·ç¨åŽåˆ·æ–°æ­¤é¡µé¢æŸ¥çœ‹å®Œæ•´çš„å‘å¸ƒåŒ…ã€‚
          
          ### ðŸš€ æˆ–è€…æ‰‹åŠ¨ä¸‹è½½
          
          æ‚¨ä¹Ÿå¯ä»¥ä»Ž [Actions](https://github.com/${{ github.repository }}/actions) é¡µé¢ä¸‹è½½æœ€æ–°æž„å»ºçš„ artifactsã€‚
          
          ### ðŸ³ Docker é•œåƒ
          
          Docker é•œåƒæž„å»ºæ˜¯ç‹¬ç«‹çš„ï¼Œåº”è¯¥å·²ç»å¯ç”¨ï¼š
          
          ```bash
          docker pull ghcr.io/${{ github.repository }}:${{ github.ref_name }}
          ```
          
          ### ðŸ“¦ å³å°†æ”¯æŒçš„å¹³å°
          
          - Linux (amd64, arm64, armv7)
          - macOS (amd64, arm64) 
          - Windows (amd64)
          EOF
          else
            # å¦‚æžœæœ‰å®žé™…æ–‡ä»¶ï¼Œåˆ›å»ºå®Œæ•´è¯´æ˜Ž
            cat > release-notes.md << 'EOF'
          ## SmartDNS Log Agent ${{ github.ref_name }}
          
          é«˜æ€§èƒ½çš„ SmartDNS æ—¥å¿—æ”¶é›†å’Œåˆ†æžä»£ç†ã€‚
          
          ### ðŸš€ å¿«é€Ÿå¼€å§‹
          
          ```bash
          # ä¸‹è½½å¯¹åº”å¹³å°çš„åŒ…
          wget https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/smartdns-log-agent-linux-amd64.tar.gz
          tar -xzf smartdns-log-agent-linux-amd64.tar.gz
          cd smartdns-log-agent-linux-amd64/
          
          # å®‰è£…
          sudo ./manage.sh install
          sudo ./manage.sh start
          ```
          
          ### ðŸ“¦ æ”¯æŒå¹³å°
          
          - Linux (amd64, arm64, armv7)
          - macOS (amd64, arm64) 
          - Windows (amd64)
          
          æ¯ä¸ªåŒ…éƒ½åŒ…å«å®Œæ•´çš„å®‰è£…è„šæœ¬å’Œé…ç½®æ–‡ä»¶ã€‚
          
          ### ðŸ”§ ç®¡ç†å‘½ä»¤
          
          ```bash
          sudo ./manage.sh install    # å®‰è£…æœåŠ¡
          sudo ./manage.sh start      # å¯åŠ¨æœåŠ¡  
          sudo ./manage.sh status     # æŸ¥çœ‹çŠ¶æ€
          sudo ./manage.sh logs       # æŸ¥çœ‹æ—¥å¿—
          sudo ./manage.sh uninstall  # å¸è½½æœåŠ¡
          ```
          EOF
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: SmartDNS Log Agent ${{ github.ref_name }}
          body_path: release-notes.md
          files: releases/*
          draft: false
          prerelease: ${{ contains(github.ref_name, 'rc') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          generate_release_notes: true
          make_latest: true