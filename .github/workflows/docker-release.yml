name: Docker Release
on:
  workflow_run:
    workflows: ["Build Docker Image"]
    types:
      - completed
  push:
    tags:
      - 'docker-v*'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  docker-release:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # ç›´æŽ¥ä»Ž tag æŽ¨é€è§¦å‘
            VERSION="${{ github.ref_name }}"
          else
            # ä»Ž workflow_run äº‹ä»¶èŽ·å–
            VERSION=$(echo "${{ github.event.workflow_run.head_branch }}" | sed 's/^docker-v//')
            if [ -z "$VERSION" ] || [ "$VERSION" = "${{ github.event.workflow_run.head_branch }}" ]; then
              # å¦‚æžœä¸æ˜¯åˆ†æ”¯ï¼Œå°è¯•ä»Ž head_sha èŽ·å– tag
              VERSION="${{ github.event.workflow_run.head_sha }}"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Wait for Docker build to complete
        if: github.event_name == 'push'
        run: |
          echo "â³ Waiting for Docker build to complete..."
          
          max_wait=600  # 10åˆ†é’Ÿè¶…æ—¶
          check_interval=30
          waited=0
          
          while [ $waited -lt $max_wait ]; do
            # æ£€æŸ¥ Docker æž„å»ºçŠ¶æ€
            runs=$(gh api "repos/${{ github.repository }}/actions/runs" \
              --jq ".workflow_runs[] | select(.head_sha == \"${{ github.sha }}\" and .name == \"Build Docker Image\") | .status" \
              2>/dev/null || echo "")
          
            if echo "$runs" | grep -q "completed"; then
              conclusion=$(gh api "repos/${{ github.repository }}/actions/runs" \
                --jq ".workflow_runs[] | select(.head_sha == \"${{ github.sha }}\" and .name == \"Build Docker Image\") | .conclusion" \
                2>/dev/null || echo "")
          
              if echo "$conclusion" | grep -q "success"; then
                echo "âœ… Docker build completed successfully!"
                break
              else
                echo "âŒ Docker build failed with conclusion: $conclusion"
                exit 1
              fi
            elif echo "$runs" | grep -q "in_progress"; then
              echo "ðŸ”„ Docker build is still running... (waited ${waited}s)"
            else
              echo "ðŸ” Docker build not found or not started yet... (waited ${waited}s)"
            fi
          
            sleep $check_interval
            waited=$((waited + check_interval))
          done
          
          if [ $waited -ge $max_wait ]; then
            echo "â° Timeout waiting for Docker build"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify Docker image
        run: |
          echo "ðŸ” Verifying Docker image availability..."
          
          # å°è¯•èŽ·å–é•œåƒä¿¡æ¯
          IMAGE_TAG="${{ steps.version.outputs.version }}"
          
          # å¦‚æžœæ˜¯ docker-v å¼€å¤´ï¼ŒåŽ»æŽ‰å‰ç¼€
          if [[ $IMAGE_TAG == docker-v* ]]; then
            IMAGE_TAG=${IMAGE_TAG#docker-v}
          fi
          
          echo "Checking image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG"
          
          # è¿™é‡Œå¯ä»¥æ·»åŠ é•œåƒéªŒè¯é€»è¾‘ï¼Œæ¯”å¦‚æ£€æŸ¥ registry API
          # æš‚æ—¶åªè®°å½•ä¿¡æ¯
          echo "Image should be available at: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$IMAGE_TAG"

      - name: Generate Docker release notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # å¦‚æžœæ˜¯ docker-v å¼€å¤´ï¼ŒåŽ»æŽ‰å‰ç¼€ç”¨äºŽæ˜¾ç¤º
          DISPLAY_VERSION=$VERSION
          if [[ $VERSION == docker-v* ]]; then
            DISPLAY_VERSION=${VERSION#docker-v}
          fi
          
          cat > docker-release-notes.md << EOF
          ## SmartDNS Manager Docker $DISPLAY_VERSION
          
          ðŸ³ **Docker é•œåƒå‘å¸ƒ**
          
          æœ¬æ¬¡å‘å¸ƒåŒ…å«äº† SmartDNS Manager çš„å®Œæ•´ Docker é•œåƒï¼Œæ”¯æŒå¤šæž¶æž„éƒ¨ç½²ã€‚
          
          ### ðŸš€ å¿«é€Ÿä½¿ç”¨
          
          \`\`\`bash
          # æ‹‰å–æœ€æ–°é•œåƒ
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$DISPLAY_VERSION
          
          # æˆ–ä½¿ç”¨ latest æ ‡ç­¾
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          \`\`\`
          
          ### ðŸ—ï¸ æ”¯æŒæž¶æž„
          
          - linux/amd64 (x86_64)
          - linux/arm64 (ARM64/aarch64)
          
          ### ðŸ“¦ éƒ¨ç½²æ–¹å¼
          
          #### ä½¿ç”¨ Docker Run
          \`\`\`bash
          docker run -d \\
            --name smartdns-manager \\
            -p 8080:8080 \\
            -v /path/to/config:/app/config \\
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$DISPLAY_VERSION
          \`\`\`
          
          #### ä½¿ç”¨ Docker Compose
          \`\`\`yaml
          version: '3.8'
          services:
            smartdns-manager:
              image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$DISPLAY_VERSION
              ports:
                - "8080:8080"
              volumes:
                - ./config:/app/config
                - ./data:/app/data
              environment:
                - ENV=production
              restart: unless-stopped
          \`\`\`
          
          ### ðŸ”§ çŽ¯å¢ƒå˜é‡
          
          | å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜Ž |
          |--------|--------|------|
          | \`PORT\` | 8080 | Web æœåŠ¡ç«¯å£ |
          | \`ENV\` | development | è¿è¡ŒçŽ¯å¢ƒ |
          | \`CONFIG_PATH\` | /app/config | é…ç½®æ–‡ä»¶è·¯å¾„ |
          
          ### ðŸ“ æ›´æ–°è¯´æ˜Ž
          
          - åŸºäºŽæœ€æ–°ä»£ç æž„å»º
          - ä¼˜åŒ–äº†é•œåƒå¤§å°å’Œå®‰å…¨æ€§
          - æ”¯æŒå¤šæž¶æž„éƒ¨ç½²
          - åŒ…å«å®Œæ•´çš„è¿è¡ŒçŽ¯å¢ƒ
          
          ### ðŸ”— ç›¸å…³é“¾æŽ¥
          
          - [æºä»£ç ](https://github.com/${{ github.repository }})
          - [é•œåƒä»“åº“](https://github.com/${{ github.repository }}/pkgs/container/${{ github.event.repository.name }})
          - [ä½¿ç”¨æ–‡æ¡£](https://github.com/${{ github.repository }}#readme)
          
          ---
          
          **é•œåƒä¿¡æ¯:**
          - æž„å»ºæ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - åŸºç¡€é•œåƒ: Alpine Linux
          - é•œåƒå¤§å°: çº¦ 50MB (åŽ‹ç¼©åŽ)
          
          **å®‰å…¨æç¤º:** å»ºè®®åœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­ä½¿ç”¨å…·ä½“çš„ç‰ˆæœ¬æ ‡ç­¾è€Œä¸æ˜¯ \`latest\`ã€‚
          EOF
          
          echo "Generated release notes:"
          cat docker-release-notes.md

      - name: Create Docker Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: SmartDNS Manager Docker ${{ steps.version.outputs.version }}
          body_path: docker-release-notes.md
          draft: false
          prerelease: false
          make_latest: false  # Docker å‘å¸ƒä¸è®¾ä¸º latestï¼Œé¿å…ä¸Žä¸»ç¨‹åºå‘å¸ƒå†²çª
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Docker documentation
        run: |
          echo "ðŸ“š Docker release created successfully!"
          echo "ðŸ·ï¸  Tag: ${{ steps.version.outputs.version }}"
          echo "ðŸ³ Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}"
          echo "ðŸ“‹ Release: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"