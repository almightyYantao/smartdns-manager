name: Create Release Packages
on:
  push:
    tags:
      - 'v*'
  workflow_run:
    workflows: ["Build Binaries"]
    types:
      - completed

env:
  BINARY_NAME: smartdns-log-agent
  AGENT_DIR: agent

jobs:
  create-packages:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'push' }}
    strategy:
      matrix:
        suffix: [linux-amd64, linux-arm64, linux-armv7, darwin-amd64, darwin-arm64, windows-amd64.exe]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # 如果是 tag 推送，先等待 binaries 构建完成
      - name: Wait for binaries (if tag push)
        if: github.event_name == 'push'
        run: |
          echo "Waiting for binaries to be built..."
          sleep 120  # 等待2分钟让 binaries 构建

      - name: Download binary artifact
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id || github.run_id }}
        continue-on-error: true

      # 如果上面失败，尝试从同一个 workflow run 下载
      - name: Download binary artifact (fallback)
        if: failure()
        uses: actions/download-artifact@v4
        with:
          name: binary-${{ matrix.suffix }}
        continue-on-error: true

      # 如果还是失败，手动构建
      - name: Build binary (fallback)
        if: failure()
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          GOARM: ${{ matrix.goarm }}
        run: |
          cd ${{ env.AGENT_DIR }}
          
          # 设置构建参数
          case "${{ matrix.suffix }}" in
            "linux-amd64") GOOS=linux GOARCH=amd64 ;;
            "linux-arm64") GOOS=linux GOARCH=arm64 ;;
            "linux-armv7") GOOS=linux GOARCH=arm GOARM=7 ;;
            "darwin-amd64") GOOS=darwin GOARCH=amd64 ;;
            "darwin-arm64") GOOS=darwin GOARCH=arm64 ;;
            "windows-amd64.exe") GOOS=windows GOARCH=amd64 ;;
          esac
          
          CGO_ENABLED=0 GOOS=$GOOS GOARCH=$GOARCH GOARM=$GOARM \
            go build -ldflags "-s -w -X main.Version=${{ github.ref_name || github.sha }}" \
            -o ../${{ env.BINARY_NAME }}-${{ matrix.suffix }} main.go

      - name: Verify binary exists
        run: |
          if [ ! -f "${{ env.BINARY_NAME }}-${{ matrix.suffix }}" ]; then
            echo "Binary not found: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}"
            ls -la
            exit 1
          fi
          echo "Binary found: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}"

      - name: Create release package
        run: |
          mkdir -p release-${{ matrix.suffix }}
          
          # 复制二进制文件
          cp ${{ env.BINARY_NAME }}-${{ matrix.suffix }} release-${{ matrix.suffix }}/
          
          # 复制配置文件（使用 2>/dev/null || true 避免文件不存在的错误）
          cp ${{ env.AGENT_DIR }}/docker-compose.yml release-${{ matrix.suffix }}/ 2>/dev/null || echo "docker-compose.yml not found"
          cp ${{ env.AGENT_DIR }}/config.env release-${{ matrix.suffix }}/ 2>/dev/null || echo "config.env not found"
          cp ${{ env.AGENT_DIR }}/README.md release-${{ matrix.suffix }}/ 2>/dev/null || echo "README.md not found"
          
          # 复制安装脚本（如果存在）
          if [ -f "${{ env.AGENT_DIR }}/install.sh" ]; then
            cp ${{ env.AGENT_DIR }}/install.sh release-${{ matrix.suffix }}/
          fi
          
          # 复制服务文件（如果存在）
          if [ -f "${{ env.AGENT_DIR }}/smartdns-log-agent.service" ]; then
            cp ${{ env.AGENT_DIR }}/smartdns-log-agent.service release-${{ matrix.suffix }}/
          fi
          
          echo "Package contents:"
          ls -la release-${{ matrix.suffix }}/

      - name: Generate management script
        run: |
          cat > release-${{ matrix.suffix }}/manage.sh << 'EOF'
          #!/bin/bash
          
          SERVICE_NAME="smartdns-log-agent"
          BINARY_NAME="smartdns-log-agent"
          
          case "$1" in
              start)
                  echo "Starting $SERVICE_NAME..."
                  sudo systemctl start $SERVICE_NAME
                  ;;
              stop)
                  echo "Stopping $SERVICE_NAME..."
                  sudo systemctl stop $SERVICE_NAME
                  ;;
              restart)
                  echo "Restarting $SERVICE_NAME..."
                  sudo systemctl restart $SERVICE_NAME
                  ;;
              status)
                  sudo systemctl status $SERVICE_NAME
                  ;;
              logs)
                  sudo journalctl -u $SERVICE_NAME -f
                  ;;
              install)
                  echo "Installing $SERVICE_NAME..."
                  # 查找二进制文件（支持不同的命名格式）
                  for binary in $BINARY_NAME-* $BINARY_NAME; do
                    if [ -f "$binary" ] && [ -x "$binary" ]; then
                      sudo cp "$binary" /usr/local/bin/$BINARY_NAME
                      break
                    fi
                  done
                  sudo chmod +x /usr/local/bin/$BINARY_NAME
          
                  # 创建用户
                  if ! id "$SERVICE_NAME" &>/dev/null; then
                      sudo useradd -r -s /bin/false $SERVICE_NAME
                  fi
          
                  # 创建配置目录
                  sudo mkdir -p /etc/$SERVICE_NAME
                  if [ -f "config.env" ]; then
                      sudo cp config.env /etc/$SERVICE_NAME/config
                  fi
                  sudo chown -R $SERVICE_NAME:$SERVICE_NAME /etc/$SERVICE_NAME
          
                  # 安装服务文件
                  if [ -f "$SERVICE_NAME.service" ]; then
                      sudo cp $SERVICE_NAME.service /etc/systemd/system/
                      sudo systemctl daemon-reload
                      sudo systemctl enable $SERVICE_NAME
                  fi
          
                  echo "Installation completed. Use 'sudo ./manage.sh start' to start the service."
                  ;;
              uninstall)
                  echo "Uninstalling $SERVICE_NAME..."
                  sudo systemctl stop $SERVICE_NAME 2>/dev/null || true
                  sudo systemctl disable $SERVICE_NAME 2>/dev/null || true
                  sudo rm -f /etc/systemd/system/$SERVICE_NAME.service
                  sudo rm -f /usr/local/bin/$BINARY_NAME
                  sudo rm -rf /etc/$SERVICE_NAME
                  sudo systemctl daemon-reload
                  echo "Uninstallation completed."
                  ;;
              *)
                  echo "Usage: $0 {start|stop|restart|status|logs|install|uninstall}"
                  exit 1
                  ;;
          esac
          EOF
          
          chmod +x release-${{ matrix.suffix }}/manage.sh

      - name: Generate install guide
        run: |
          cat > release-${{ matrix.suffix }}/INSTALL.md << 'EOF'
          # SmartDNS Log Agent 安装指南
          
          ## 快速安装
          
          ```bash
          # 使用管理脚本安装
          sudo ./manage.sh install
          
          # 启动服务
          sudo ./manage.sh start
          
          # 查看状态
          sudo ./manage.sh status
          ```
          
          ## Docker 部署
          
          ```bash
          # 编辑环境变量
          cp config.env .env
          nano .env
          
          # 启动服务
          docker-compose up -d
          ```
          
          ## 配置说明
          
          编辑 `/etc/smartdns-log-agent/config` 文件或环境变量：
          
          ```bash
          NODE_ID=1
          CLICKHOUSE_HOST=localhost
          CLICKHOUSE_PORT=9000
          CLICKHOUSE_DB=smartdns_logs
          CLICKHOUSE_USER=default
          CLICKHOUSE_PASSWORD=your-password
          LOG_FILE=/var/log/smartdns/smartdns.log
          BATCH_SIZE=1000
          FLUSH_INTERVAL_SEC=2
          ```
          
          ## 管理命令
          
          ```bash
          sudo ./manage.sh start     # 启动服务
          sudo ./manage.sh stop      # 停止服务
          sudo ./manage.sh restart   # 重启服务
          sudo ./manage.sh status    # 查看状态
          sudo ./manage.sh logs      # 查看日志
          sudo ./manage.sh install   # 安装服务
          sudo ./manage.sh uninstall # 卸载服务
          ```
          EOF

      - name: Create package
        run: |
          tar -czf ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz -C release-${{ matrix.suffix }} .
          
          echo "Package created:"
          ls -la ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz

      - name: Upload package artifact
        uses: actions/upload-artifact@v4
        with:
          name: package-${{ matrix.suffix }}
          path: ${{ env.BINARY_NAME }}-${{ matrix.suffix }}.tar.gz
          retention-days: 30